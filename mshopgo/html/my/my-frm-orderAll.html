<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>我的订单-全部</title>
    <link rel="stylesheet" href="../../css/commen1.css">
    <link rel="stylesheet" href="../../css/aui/aui.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/s-style.css">
    <style>
        .aui-dialog-btn{
            color:#ff5096;
        }
        .aui-dialog-body{
            color:#212121;
            font-size:0.8rem;
        }
        #wrap header{
          background:white;
        }
        #wrap header a span{
          color:#000!important;
        }
        #wrap header .aui-title{
          color:#000;
        }
        #tab{
          display:block;
        }
        #tab .aui-tab-item{
          width:20%;
          float: left;
        }
    </style>
</head>
<body>
  <div id="wrap" class="flex-wrap flex-vertical">
      <header class="aui-bar aui-bar-nav tit-bar-black">
          <a class="aui-pull-left aui-btn" onclick="window.history.back()">
              <span class="aui-iconfont aui-icon-left"></span>
          </a>
          <div class="aui-title">我的订单</div>
      </header>
      <div class="aui-tab aui-border-t" id="tab" style="width:100%;">
          <div class="aui-tab-item aui-active" data-id="1">全部</div>
          <div class="aui-tab-item" data-id="2">待付款</div>
          <div class="aui-tab-item" data-id="3">待成团</div>
          <div class="aui-tab-item" data-id="4">待收货</div>
          <div class="aui-tab-item" data-id="5">待评价</div>
      </div>

<!--暂无订单-->
<div id="empty" class="aui-hide" style="width:100%;">
    <!--暂无订单-->
    <div class="order-if-noshop">
        <img src="../../image/my/wddd_kong_icon.png"/>
        <dl>
            <dt>暂无订单</dt>
            <dd class="aui-font-size-12 color-gray9">再忙也不能忘记买买买</dd>
        </dl>
        <span class="aui-font-size-20 cart-section-go my-noshop-btn aui-margin-t-15" onclick="openIndexWin()">去首页逛逛</span>
    </div>
    <!--好货推荐-->
    <div class="order-recommend ">
        <h4><span></span>好货推荐<span></span></h4>
        <div class="shop-view aui-slide-node aui-slide-node-middle aui-slide-node-center">
            <ul class="clearfix aui-padded-l-10 ">
                <li class="aui-pull-left border cart-bg-fff aui-margin-r-10">
                    <img src="../../image/test.jpg" alt="">
                    <p class="aui-padded-l-5 aui-padded-r-5 aui-ellipsis-1">标题标题标题标题标题标题标题标题标题标题标题标题标题标题标题</p>

                    <div class="cart-section-bottom clearfix aui-padded-l-5 aui-padded-r-5 ">
                        <p class="aui-pull-left">
                            <strong class="aui-font-size-14 cart-section-prize color-pink">￥39.9</strong>
                            <!--<em class="aui-font-size-10 text-line">￥599</em>-->
                        </p>

                        <p class="aui-pull-right aui-font-size-12"> 已售:68989</p>
                    </div>
                </li>
                <li class="aui-pull-left border cart-bg-fff aui-margin-r-10">
                    <img src="../../image/test.jpg" alt="">

                    <p class="aui-padded-l-5 aui-padded-r-5 aui-ellipsis-1">标题标题标题标题标题标题标题标题标题标题标题标题标题标题标题</p>

                    <div class="cart-section-bottom clearfix aui-padded-l-5 aui-padded-r-5 ">
                        <p class="aui-pull-left">
                            <strong class="aui-font-size-14 cart-section-prize color-pink">￥39.9</strong>
                            <!--<em class="aui-font-size-10 text-line">￥599</em>-->
                        </p>

                        <p class="aui-pull-right aui-font-size-12"> 已售:68989</p>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</div>
<div id="orderlist">
</div>
</div>
<script type="text/html/x-dot-template" id="info_tmpl">
    {{?it.data.length>0}} {{~it.data:dval:dkey}}
    <section class="cart-bg-fff order-section-padd aui-margin-t-10" id="{{=dval.orderRes.oid}}" >
        <h4 class="clearfix aui-padded-t-10">
            {{?dval.orderRes.order_type==2}}
            <span class="order-top-img">
                {{?dval.shopRes!=null}}
                    <img src="{{=dval.shopRes.logo}}" class="aui-pull-left aui-margin-r-10"/>{{=dval.shopRes.name}} >
                    {{??}}
                    <img src="" class="aui-pull-left aui-margin-r-10"/>
                    {{?}}
              <!--<em class="aui-font-size-10 color-gray9">-->
                  <!--{{?dval.orderRes.pay_time}}-->
                  <!--{{=dval.orderRes.pay_time.substr(0,10)}}-->
                  <!--{{?}}-->
              <!--</em>-->
              <!--{{?dval.orderRes.group_oid==dval.orderRes.oid}}-->
                <!--发起了拼单-->
                <!--{{??}}-->
                <!--参与了拼单-->
                <!--{{?}}-->
            </span>
            <!--<br>-->
            <span style="display: none;">
                {{?dval.orderRes.group_done==1}}
              <em class="color-gray9 aui-padded-r-10 aui-font-size-10 lefttime"  paytime="{{=dval.orderRes.pay_time}}"
                  grouphours="{{=dval.orderRes.group_hours}}"></em>
                {{?}}
              <em class="color-pink">
                  {{?dval.orderRes.group_done==2}}
                  拼团成功
                  {{??dval.orderRes.group_done==1}}
                  拼单中，差{{=(dval.orderRes.group_neednum-dval.orderRes.group_havenum)}}人
                  {{?}}
              </em>
            </span>
            <span class="aui-pull-right">
                {{?dval.orderRes.group_done==1}}
              <em class="color-gray9 aui-padded-r-10 aui-font-size-10 lefttime"  paytime="{{=dval.orderRes.pay_time}}"
                  grouphours="{{=dval.orderRes.group_hours}}"></em>
                {{?}}
              <em class="color-pink">
                  {{?dval.orderRes.group_done==2}}
                  拼团成功
                  {{??dval.orderRes.group_done==1}}
                  待分享
                  {{?}}
              </em>
            </span>
            {{??}}
                  <span class="order-top-img">
                    {{?dval.shopRes!=null}}
                    <img src="{{=dval.shopRes.logo}}" class="aui-pull-left aui-margin-r-10"/>{{=dval.shopRes.name}}>
                    {{??}}
                    <img src="" class="aui-pull-left aui-margin-r-10"/>
                    {{?}}
                </span>
                    <span class="aui-pull-right">
                      <em class="color-gray9 aui-padded-r-10"></em>
                      <em class="color-pink">
                          {{?dval.orderRes.close_reason==0}}
                          {{?dval.orderRes.status==1}}
                          待支付
                          {{?? dval.orderRes.status==2}}
                          待发货
                          {{??dval.orderRes.status==3}}
                          待收货
                          {{??dval.orderRes.status==4&&dval.orderRes.comment==1}}
                          待评价
                          {{?}}

                          {{??}}
                          已关闭
                          {{?}}

                      </em>
                    </span>
            {{?}}
        </h4>
        <ul class="aui-list aui-media-list" style="top:0.5rem;" onclick="showOrderDetails({{=dval.orderRes.oid}});">
            {{~dval.goodsRes:goods}}
            <li class="aui-list-item aui-padded-l-0 cart-bg-fff">
                <div class="aui-media-list-item-inner">
                    <div class="aui-list-item-media cart-left-img">
                        <img src="{{=goods.skuGoodsJson.pic}}
                        ">
                    </div>
                    <div class="aui-list-item-inner aui-padded-r-0">
                        <div class="aui-list-item-text">
                            <p class="aui-ellipsis-2 s-color-black">{{=goods.skuGoodsJson.gname}}</p>
                        </div>
                        <div class="aui-info aui-margin-t-15" style="padding:0">
                            <div class="aui-info-item">
                                <span class="s-color-black">￥{{=goods.skuGoodsJson.price}}</span>
                            </div>
                            <div class="aui-info-item">
                                {{?dval.orderRes.order_type==2}} {{=dval.orderRes.group_havenum}}人拼单 {{??}} ×{{=goods.goods_count}} {{?}}
                            </div>
                        </div>
                    </div>
                </div>
            </li>
            {{~}}
        </ul>
        <p class="aui-text-right s-color-black aui-padded-t-15 aui-padded-b-10">实付：￥{{=dval.orderRes.pay_money}}（免运费）</p>
        <div class="aui-text-right aui-margin-t-15">
            {{?dval.orderRes.close_reason==0}}
            {{?dval.orderRes.status==1}}
            <span class="aui-font-size-16 cart-section-go s-color-black s-border-gray aui-margin-r-10" onclick="cancleOrder('{{=dval.orderRes.oid}}')">取消订单</span>
            <span class="aui-font-size-16 cart-section-go" onclick="gotoPay('{{=dval.orderRes.oid}}')">立即支付</span>
            {{??dval.orderRes.status==2 && dval.orderRes.order_type==2 && dval.orderRes.group_done==1 }} {{~dval.userRes:users}}
            <img src="{{=users.avatar}}" class="aui-img-round aui-pull-left s-img-width" /> {{~}}
            <span class="aui-font-size-16 cart-section-go s-color-black s-border-gray aui-margin-r-10" onclick="gotoShare('{{=dval.goodsRes[0].skuGoodsJson.gid}}','{{=dval.goodsRes[0].skuGoodsJson.gname}}','{{=dval.goodsRes[0].skuGoodsJson.pic}}','{{=dval.goodsRes[0].skuGoodsJson.price}}')">邀好友拼单</span>
            {{??dval.orderRes.status==3}}
            <span class="aui-font-size-16 cart-section-go s-color-black s-border-gray aui-margin-r-10 s-min-width" onclick="showExpress('{{=dval.orderRes.express_no}}','{{=dval.orderRes.express_type}}')">查看物流</span>
            <span class="aui-font-size-16 cart-section-go s-min-width" onclick="$a.toast('已向商家催单')">催单</span>
            <span class="aui-font-size-16 cart-section-go s-min-width" onclick="confirmReceive('{{=dval.orderRes.oid}}')">确认收货</span>
            {{??dval.orderRes.status==4&&dval.orderRes.comment==1}}
                <span class="order-more-btn aui-margin-r-10"onclick="showOrHide(this);">
                    更多
                    <ul class="aui-hide">
                        <li onclick="showExpress('{{=dval.orderRes.express_no}}','{{=dval.orderRes.express_type}}')">查看物流</li>
                        <li onclick="deleteOrder('{{=dval.orderRes.oid}}');">删除订单</li>
                    </ul>
                </span>
            <span class="aui-font-size-16 cart-section-go s-color-black s-border-gray aui-margin-r-10" onclick="showGoodsDetail('{{=dval.goodsRes[0].skuGoodsJson.gid}}')">再次购买</span>
            <span class="aui-font-size-16 cart-section-go" onclick="$a.openWin('my_frm-comment','oid:{{=dval.orderRes.oid}}')">立即评价</span>
            {{?}}

            {{??}}
            <span class="aui-font-size-16 cart-section-go s-color-black s-border-gray aui-margin-r-10" onclick="deleteOrder('{{=dval.orderRes.oid}}');">删除订单</span>
            {{?}}
        </div>
    </section>
    {{~}} {{?}}
</script>
<script src="../../script/jquery-1.11.1.min.js"></script>
<script src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/getData.js"></script>
<script type="text/javascript" src="../../script/aui/aui-tab.js"></script>
<script src="../../script/config.js"></script>
<script src="../../script/base.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/aui/aui-toast.js"></script>
<script src="../../script/aui/aui-dialog.js"></script>
<script src="../../script/yltcrypt.js"></script>
<script>
    var user, type,
            page = totalpage = 1;
    var user = $api.getStorage('user');
    var toast = new auiToast({
   })
   var type = pageParam().type;
    window.onload = function() {

        tabLoading(type);
      var tab = new auiTab({
          index: type,
          element: document.getElementById('tab')
      }, function (ret, err) {
          // api.setFrameGroupIndex({
          //     name: 'myOder',
          //     index: ret.index - 1,
          //     scorll: false
          // });
             var Dataid=ret.dom.getAttribute("data-id");
            //  console.log(Dataid)
             tabLoading(Dataid);
      });
      // funInGroup();
      var eHeaderLis = $api.domAll('#tab > div');
      function funInGroup() {
          var frames = [],
           frameName = [
                      'my-frm-orderAll',
                      'my-frm-orderPayment',
                      'my-frm-orderGroup',
                      'my-frm-orderGoods',
                      'my-frm-orderEvaluate'
                  ];

          for (var i = 0; i < eHeaderLis.length; i++) {
              frames.push({
                  name: 'myOder',
                  url: frameName[i] + '.html',
                  bounces: false,
              })
          }
      }

        // user = localStorage.getItem('user')
        // loadOrder();
        /* 底部加载数据 */
        // $a.addEvt({
        //     name: 'scrolltobottom',
        //     extra: {
        //         threshold: 50
        //     }
        // }, function(ret, err) {
        //     if (page <= totalpage) {
        //         loadOrder();
        //     }
        // });
        // $a.addEvt('orderAll-reload',function(){
        //     location.reload();
        // });

       //滚动加载数据
        $(window).scroll(function(){
        　　var scrollTop = $(this).scrollTop();
        　　var scrollHeight = $(document).height();
        　　var windowHeight = $(this).height();
        　　if(scrollTop + windowHeight == scrollHeight){
            tabLoading();
        // 　　 loadOrder();//加载数据的函数
        　　}
        });
    }
    function gotoShare(gid,gname,gpic,gprice){
      window.location.href="../share/share?"+"img="+gpic+"&"+"title="+gname+"&"+"desciption=¥"+gprice+"&"+"gid="+gid;
        // $a.openFrm('../share/share','img:'+gpic+',title:'+gname+',desciption:¥'+gprice+',gid:'+gid);
    }
    //订单列表
    function loadOrder() {
        $.ajax({
            url: PHP_SERVE_URL + '/order/my',
            method: 'post',
            data: {
                // values: {
                    openId: user.openId,
                    type: type,
                    page: page,
                    orderType:1
                // }
            },
            success:function(ret, err) {

                if (ret.code == 0) {
                    page++;
                    totalpage = ret.total;
                    if (totalpage == 0) {
                        if ($api.hasCls($api.byId('empty'), 'aui-hide')) {
                            $api.removeCls($api.byId('empty'), 'aui-hide');
                        }
                        $api.addCls($api.byId('orderlist'), 'aui-hide');
                    } else {
                        $api.addCls($api.byId('empty'), 'aui-hide');
                        if ($api.hasCls($api.byId('orderlist'), 'aui-hide')) {
                            $api.removeCls($api.byId('orderlist'), 'aui-hide');
                        }
                        var innerText = doT.template($api.text($api.byId("info_tmpl")));
                        $api.append($api.byId("orderlist"), innerText(ret));
                        // $(".lefttime").map(function () {
                        //     var self = $(this);
                        //     var paytime = self.attr("paytime");
                        //     var hours = self.attr("grouphours")
                        //     var time = (new Date(paytime)).getTime() + hours * 60 * 60 * 1000;
                        //     var nowtime = (new Date()).getTime();
                        //     if (time > nowtime) {
                        //         GetRTime(self, time);
                        //         setInterval(function () {
                        //             GetRTime(self, time);
                        //         }, 1000);
                        //     }
                        // })
                    }
                }
            }
        });
    }
    function GetRTime(ele, endtime) {
        //当前时间
        var NowTime = (new Date()).getTime();
        //结束时间减去当前时间剩余的毫秒数
        var t = endtime - NowTime;
        var d = Math.floor(t / 1000 / 60 / 60 /24 % 24);//天
        var h = Math.floor(t / 1000 / 60 / 60 % 60);//时
        var m = Math.floor(t / 1000 / 60 % 60);//分
        var s = Math.floor(t / 1000 % 60);//秒
        ele.text(d+"天"+h + "小时" + m + "分" + s + "秒");
    }
    function showOrderDetails(oid) {
      window.location.href="./my_frm-orderDetail.html?"+"oid="+oid
        // api.openWin({
        //     name: 'orderDetails',
        //     url: './my_frm-orderDetail.html',
        //     pageParam: {
        //         oid: oid
        //     }
        // });
    }
    //取消订单
    function cancleOrder(oid){
        var dialog=new auiDialog();
        dialog.alert({
            msg:'确定取消此订单？',
            buttons:['取消','确定']
        },function(ret){
            if(ret.buttonIndex==2){
                $.ajax({
                    url:PHP_SERVE_URL+'/order/cancleOrder',
                    method:'post',
                    data:{
                        // values:{
                            openId:user.openId,
                            oid:oid,
                            token:yltcrypt.cpt(user.openId)
                        // }
                    },
                    success:function(ret){
                        if(ret.code==0){
                            // $a.sendEvt('orderPayment-reload');
                            window.location.reload();
                        }else{
                          toast.loading({
                            title:ret.msg,
                            duration:2000
                        },function(ret){
                            // console.log(ret.msg);
                            setTimeout(function(){
                                toast.hide();
                            }, 3000)
                          })
                            // $a.toast(ret.msg);
                        }
                    }
                })
            }
        })
    }
    //立即支付
    function gotoPay(oid){
        $.ajax({
            url:PHP_SERVE_URL+'/order/againPay',
            method:'post',
            data:{
                // values:{
                    openId:user.openId,
                    oid:oid
                // }
            },
            success:function(ret){
                if(ret.code==0){
                  window.location.href="../pay/pay_win.html?"+"needPayMoney="+ret.needPayMoney+"&"+"orderNo"+ret.orderNo;
                    // $a.openWin('../pay/pay_win','needPayMoney:'+ret.needPayMoney+',orderNo:'+ret.orderNo);
                }else{
                  toast.loading({
                    title:ret.msg,
                    duration:2000
                },function(ret){
                    // console.log(ret.msg);
                    setTimeout(function(){
                        toast.hide();
                    }, 3000)
                  })
                }
            }
        })
    }
     //更多
    function showOrHide(that){
        $(that).find("ul").toggleClass("aui-hide")
    }
    //删除订单
    function deleteOrder(oid){
        var dialog=new auiDialog();
        dialog.alert({
            msg:'确定删除此订单？',
            buttons:['取消','确定']
        },function(ret){
            if(ret.buttonIndex==2){
                $.ajax({
                    url:PHP_SERVE_URL+'/order/deleteOrder',
                    method:'post',
                    data:{
                        // values:{
                            openId:user.openId,
                            oid:oid
                        // }
                    },
                    success:function(ret){
                        if(ret.code==0){
                          toast.success({
                            title:"删除订单成功",
                          })
                            // $a.toast("删除订单成功");
                            $("#"+oid).remove();
                            // window.location.reload();
                            if($("section").length==0){
                                window.location.reload();
                            }
                        }else{
                          toast.fail({
                           title:ret.msg
                          })
                            // $a.toast(ret.msg);
                        }

                    }
                })
            }
        })
    }
    function openIndexWin() {
        // $a.sendEvt('index-show');
        // $a.openWin('../index_win');
        window.location.href="../index/index_frm.html"
    }
    //确认收货
    function confirmReceive(oid){
        $.ajax({
            url:PHP_SERVE_URL+"/order/recep",
            method:'post',
            data:{
                // values:{
                    openId:user.openId,
                    oid:oid
                // }
            }
        },function(ret,err){
            if(ret.code==0){
              toast.loading({
                title:"已确认收货",
                duration:2000
            },function(ret){

                setTimeout(function(){
                    toast.hide();
                }, 3000)
              })
                // $a.toast("已确认收货");
                $("#"+oid).remove();
                if($("section").length==0){
                    window.location.reload();
                }
                api.sendEvent({
                    name:'reload-orderGoods'
                });
                api.sendEvent({
                    name:'evaluateOrder-reload'
                });
            }else{
              toast.loading({
                title:ret.msg,
                duration:2000
            },function(ret){
                // console.log(ret);
                setTimeout(function(){
                    toast.hide();
                }, 3000)
              })
                // $a.toast(ret.msg);
            }
        })
    }
    //查看物流
    function showExpress(no,type){
        if(no!="" && type!=""){
          window.location.href="../my/my_frm-logistics.html?"+"express_no="+no+"&"+"express_type="+type
            // $a.openWin('../my/my_frm-logistics','express_no:'+no+",express_type:"+type);
        }else{
          toast.loading({
            title:"暂无物流信息",
            duration:2000
        },function(ret){

            setTimeout(function(){
                toast.hide();
            }, 3000)
          })
            // $a.toast("暂无物流信息");
        }
    }
    function showGoodsDetail(gid){
      window.location.href="../goods/goods_win.html?"+"id="+gid
        // $a.openWin("../goods/goods_win",'id:'+gid);
    }

    //tab数据加载
    function tabLoading(id){
        $.ajax({
            url: PHP_SERVE_URL + '/order/my',
            method: 'post',
            data: {
                // values: {
                    openId: user.openId,
                    type: id,
                    page: page,
                    orderType:1
                // }
            },
            success:function(ret, err) {
                if (ret.code == 0) {
                    page=1;
                    totalpage = ret.total;
                    // console.log(ret.data)
                    if (totalpage == 0) {
                        if ($api.hasCls($api.byId('empty'), 'aui-hide')) {
                            $api.removeCls($api.byId('empty'), 'aui-hide');
                        }
                        $api.addCls($api.byId('orderlist'), 'aui-hide');
                    } else {
                        $api.addCls($api.byId('empty'), 'aui-hide');
                        if ($api.hasCls($api.byId('orderlist'), 'aui-hide')) {
                            $api.removeCls($api.byId('orderlist'), 'aui-hide');
                        }
                        var innerText = doT.template($api.text($api.byId("info_tmpl")));
                        $api.html($api.byId("orderlist"), innerText(ret));
                        // $(".lefttime").map(function () {
                        //     var self = $(this);
                        //     var paytime = self.attr("paytime");
                        //     var hours = self.attr("grouphours")
                        //     var time = (new Date(paytime)).getTime() + hours * 60 * 60 * 1000;
                        //     var nowtime = (new Date()).getTime();
                        //     if (time > nowtime) {
                        //         GetRTime(self, time);
                        //         setInterval(function () {
                        //             GetRTime(self, time);
                        //         }, 1000);
                        //     }
                        // })
                    }
                }
            }
        });
      }
</script>
</body>
</html>
